name: GPU Price Scraper Pipeline

on:
  schedule:
    - cron: '0 0,12 * * *'  # Runs at 0:00 and 12:00 UTC daily (every 12 hours)
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]  # Run on push for testing

permissions:
  contents: write  # Allow writing to repository
  actions: read    # Allow reading actions

jobs:
  scrape-and-calculate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch full history for proper git operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests beautifulsoup4 selenium webdriver-manager lxml openpyxl web3 eth-account python-dotenv supabase
        # Add any other dependencies your scrapers need
    
    - name: Install Chrome and ChromeDriver (if needed for selenium)
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Step 1 - Run Scrapers
      run: |
        echo "Starting scraper pipeline..."
        echo "Running scraper20.py..."
        python scraper20.py || echo "scraper20.py failed, continuing..."
        
        echo "Running scraper-1.py..."
        python scraper-1.py || echo "scraper-1.py failed, continuing..."
        
        echo "Running aws_scraper.py..."
        python aws_scraper.py || echo "aws_scraper.py failed, continuing..."
        
        echo "Running runpod_scraper.py..."
        python runpod_scraper.py || echo "runpod_scraper.py failed, continuing..."

        echo "Running atlanticnet_scraper.py..."
        python atlanticnet_scraper.py || echo "atlanticnet_scraper.py failed, continuing..."

        echo "Running azure_scraper_fixed.py..."
        python azure_scraper_fixed.py || echo "azure_scraper_fixed.py failed, continuing..."
        
        echo "Scrapers completed. Checking output files..."
        ls -la *.json || echo "No JSON files found"
    
    - name: Step 2 - Merge JSON Files
      run: |
        echo "Running combined.py to merge all data sources..."
        python combined.py || echo "combined.py failed, continuing..."
        echo "Combined script completed"
        ls -la multi_cloud_h100_prices.json || echo "multi_cloud_h100_prices.json not found"

    - name: Step 3 - Convert JSON to CSV
      run: |
        echo "Converting JSON files to CSV..."
        python json_to_csv_converter.py
        echo "JSON to CSV conversion completed"
        ls -la h100_prices_combined.csv || echo "h100_prices_combined.csv not found"
    
    - name: Step 4 - Clean and Convert Currencies
      run: |
        echo "Cleaning data and converting currencies..."
        python clean_and_convert_currencies.py
        echo "Currency conversion completed"
        ls -la h100_prices_usd.csv || echo "h100_prices_usd.csv not found"

    - name: Step 5 - Normalize Prices
      run: |
        echo "Normalizing prices..."
        python normalize.py
        echo "Price normalization completed"
        ls -la gpu_prices_normalized.csv || echo "gpu_prices_normalized.csv not found"

    - name: Step 6 - Calculate GPU Index
      run: |
        echo "Calculating GPU index..."
        python gpu_index_calculator.py
        echo "GPU index calculation completed"
        ls -la h100_gpu_index.csv || echo "h100_gpu_index.csv not found"

    - name: Step 7 - Push to Sepolia Smart Contract
      env:
        SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
        ORACLE_UPDATER_PRIVATE_KEY: ${{ secrets.ORACLE_UPDATER_PRIVATE_KEY }}
        BOT_MODE: true
      run: |
        echo "Pushing H100 index price to Sepolia contract..."
        if [ -f "h100_gpu_index.csv" ]; then
          # Use --no-verify for faster execution, always push the newly calculated price
          python push_to_contract.py --csv h100_gpu_index.csv --no-verify || echo "âš ï¸ Contract push failed (non-blocking)"
        else
          echo "âš ï¸ h100_gpu_index.csv not found, skipping contract push"
        fi
        echo "Contract push step completed"

    - name: Step 8 - Push Individual Provider Prices to Contract
      env:
        SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
        ORACLE_UPDATER_PRIVATE_KEY: ${{ secrets.ORACLE_UPDATER_PRIVATE_KEY }}
      run: |
        echo "Pushing individual H100 provider prices to Sepolia contract..."
        if [ -f "provider_averages.csv" ]; then
          # Extract prices and apply discounts (AWS: 44%, Azure: 65%, GCP: 65%)
          AWS_PRICE=$(python -c "
          import pandas as pd
          df = pd.read_csv('provider_averages.csv')
          row = df[df['Provider'] == 'Amazon Web Services']
          if not row.empty:
              price = float(row['AvgNormalizedPrice'].iloc[0])
              print(f'{price * (1 - 0.44):.4f}')
          else:
              print('0')
          " 2>/dev/null || echo "0")

          AZURE_PRICE=$(python -c "
          import pandas as pd
          df = pd.read_csv('provider_averages.csv')
          row = df[df['Provider'] == 'Microsoft Azure']
          if not row.empty:
              price = float(row['AvgNormalizedPrice'].iloc[0])
              print(f'{price * (1 - 0.65):.4f}')
          else:
              print('0')
          " 2>/dev/null || echo "0")

          GCP_PRICE=$(python -c "
          import pandas as pd
          df = pd.read_csv('provider_averages.csv')
          row = df[df['Provider'] == 'Google Cloud']
          if not row.empty:
              price = float(row['AvgNormalizedPrice'].iloc[0])
              print(f'{price * (1 - 0.65):.4f}')
          else:
              print('0')
          " 2>/dev/null || echo "0")

          echo "Extracted prices (after discounts):"
          echo "  AWS: \$${AWS_PRICE}/hr"
          echo "  Azure: \$${AZURE_PRICE}/hr"
          echo "  GCP: \$${GCP_PRICE}/hr"

          # Only push if we have valid prices
          if [ "$AWS_PRICE" != "0" ] || [ "$AZURE_PRICE" != "0" ] || [ "$GCP_PRICE" != "0" ]; then
            ARGS=""
            [ "$AWS_PRICE" != "0" ] && ARGS="$ARGS --aws $AWS_PRICE"
            [ "$AZURE_PRICE" != "0" ] && ARGS="$ARGS --azure $AZURE_PRICE"
            [ "$GCP_PRICE" != "0" ] && ARGS="$ARGS --gcp $GCP_PRICE"

            python push_h100_individual_prices.py $ARGS --batch || echo "âš ï¸ Individual prices push failed (non-blocking)"
          else
            echo "âš ï¸ No valid provider prices found, skipping"
          fi
        else
          echo "âš ï¸ provider_averages.csv not found, skipping individual prices push"
        fi
        echo "Individual provider prices push completed"

    - name: Display Results
      run: |
        echo "=== PIPELINE RESULTS ==="
        echo "Final GPU Index Results:"
        if [ -f "h100_gpu_index.csv" ]; then
          cat h100_gpu_index.csv
        else
          echo "h100_gpu_index.csv not found"
        fi
        
        echo ""
        echo "=== FILE SIZES ==="
        ls -lh *.csv *.json || echo "No output files found"
    
    - name: Create results summary
      run: |
        echo "# GPU Price Index Results - $(date)" > results_summary.md
        echo "" >> results_summary.md
        echo "## Pipeline Status" >> results_summary.md
        echo "- Scrapers: âœ… Completed" >> results_summary.md
        echo "- JSON to CSV: âœ… Completed" >> results_summary.md
        echo "- Currency Conversion: âœ… Completed" >> results_summary.md
        echo "- Price Normalization: âœ… Completed" >> results_summary.md
        echo "- Index Calculation: âœ… Completed" >> results_summary.md
        echo "- Smart Contract Push: âœ… Attempted" >> results_summary.md
        echo "" >> results_summary.md
        
        if [ -f "h100_gpu_index.csv" ]; then
          echo "## Latest Index Prices" >> results_summary.md
          echo '```' >> results_summary.md
          cat h100_gpu_index.csv >> results_summary.md
          echo '```' >> results_summary.md
        fi
        
        echo "" >> results_summary.md
        echo "## Generated Files" >> results_summary.md
        echo '```' >> results_summary.md
        ls -lh *.csv *.json 2>/dev/null || echo "No files generated" >> results_summary.md
        echo '```' >> results_summary.md
    
    - name: Configure Git
      run: |
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
    
    - name: Commit and push results
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Add all generated files
        git add *.csv *.json results_summary.md 2>/dev/null || true

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ¤– Update GPU prices and index - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin main
          echo "Results committed and pushed successfully"
        fi

    - name: Run autorun.py
      run: |
        echo "Running autorun.py..."
        python autorun.py
        echo "autorun.py completed"

    - name: Push H100 Hyperscaler Prices to Supabase
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: |
        echo "Pushing H100 hyperscaler prices to Supabase..."
        python push_h100_hyperscalers.py || echo "âš ï¸ push_h100_hyperscalers.py failed (non-blocking)"
        echo "Hyperscaler push completed"

    - name: Upload artifacts (backup)
      uses: actions/upload-artifact@v4
      with:
        name: gpu-pricing-data
        path: |
          *.csv
          *.json
          results_summary.md
        retention-days: 30
    
    - name: Notify on failure
      if: failure()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "âŒ GPU Price Scraper Pipeline Failed"
        echo "Check the logs above for details"
        echo "Timestamp: $(date)"
        
        # Create failure report
        echo "# âŒ Pipeline Failure Report - $(date)" > failure_report.md
        echo "" >> failure_report.md
        echo "The GPU price scraper pipeline failed. Please check the GitHub Actions logs for details." >> failure_report.md
        echo "" >> failure_report.md
        echo "## Available Files" >> failure_report.md
        echo '```' >> failure_report.md
        ls -la 2>/dev/null || echo "No files found" >> failure_report.md
        echo '```' >> failure_report.md
        
        git add failure_report.md
        git commit -m "âŒ Pipeline failure report - $(date)" || true
        git push origin main || true
